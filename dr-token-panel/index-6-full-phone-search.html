<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Clinic Management Panel (Local Storage)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #1D4ED8; /* Blue 700 */
            --color-success: #10B981; /* Emerald 500 */
            --color-warning: #F59E0B; /* Amber 500 */
            --color-danger: #EF4444; /* Red 500 */
            --color-info: #6366F1; /* Violet 500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
        }
        /* Custom styles for clear visual status */
        .status-card {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            @apply shadow-md hover:shadow-xl;
        }

        .status-waiting { background-color: var(--color-warning); @apply text-amber-900; }
        .status-consulting { background-color: var(--color-info); @apply text-violet-50; }
        .status-finished { background-color: var(--color-success); @apply text-emerald-900; }
        .status-noshow { background-color: var(--color-danger); @apply text-red-50; }
        .status-default { @apply bg-gray-100 text-gray-500; }

        .doctor-status-text-ARRIVED { @apply text-emerald-600; }
        .doctor-status-text-DEPARTED { @apply text-red-600; }
        .token-clickable:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>

    <div class="min-h-screen p-4 md:p-6">
        <!-- Header -->
        <header class="mb-6 pb-4 border-b border-gray-200 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Clinic Live Panel (Local Data)</h1>
                <p class="text-gray-500">Data saved locally in your browser.</p>
            </div>
            <!-- Removed Firebase Connection Status Indicator -->
        </header>

        <!-- Doctor Management Panel -->
        <div id="doctor-panel" class="bg-white p-4 rounded-xl shadow-lg mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <h2 class="text-xl font-semibold mb-2 sm:mb-0">Doctor Status:
                    <span id="doctor-status-display" class="font-bold ml-2"></span>
                </h2>
                <button id="doctor-toggle-btn"
                    class="w-full sm:w-auto px-6 py-3 text-white font-medium rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-[1.02] active:scale-95 text-lg"
                    aria-label="Toggle Doctor Status">
                    Loading...
                </button>
            </div>
        </div>

        <!-- Patient Token Board -->
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Patient Token Board (1-50)</h2>
        
        <!-- NEW: Search/Filter Bar -->
        <div class="mb-6 flex space-x-3">
            <input type="text" id="search-input" placeholder="Search by Token #, Name, or Phone (full number)"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm transition"
                   aria-label="Search patient tokens">
            <button id="clear-search-btn"
                    class="px-4 py-2 bg-gray-400 text-white font-medium rounded-lg shadow-md hover:bg-gray-500 transition duration-150 ease-in-out">
                Clear
            </button>
        </div>
        <!-- END NEW -->


        <div id="token-board"
             class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3">
            <!-- Token cards will be injected here -->
            <p class="text-center col-span-full py-10 text-gray-400" id="loading-message">Loading local data...</p>
        </div>

        <!-- Custom Modal/Notification Area (For alerts/prompts) -->
        <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full">
                <h3 id="modal-title" class="text-2xl font-bold mb-4">Update Token Status</h3>
                
                <!-- Patient Details Block -->
                <div class="border p-4 rounded-lg bg-gray-50 mb-6">
                    <p class="text-sm text-gray-500 mb-1">Token Number:</p>
                    <h4 id="modal-token-display" class="text-3xl font-extrabold text-blue-600 mb-3">#0</h4>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Patient Name</p>
                            <p id="modal-patient-name" class="text-lg font-semibold text-gray-800">N/A</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">Phone Number</p>
                            <p id="modal-phone-number-masked" class="text-lg font-semibold text-gray-800">N/A</p>
                        </div>
                    </div>
                </div>

                <p id="modal-body" class="mb-6 text-lg text-gray-700 font-medium">Current Status: <span id="modal-current-status" class="font-bold text-violet-600">N/A</span></p>

                <div id="modal-feedback" class="h-6 text-sm mb-4"></div> <!-- Feedback area for success/error -->

                <div id="modal-actions" class="flex flex-col space-y-3">
                    <!-- Status buttons will be injected here -->
                </div>
                <button id="modal-close-btn" class="mt-4 w-full py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Close Panel</button>
            </div>
        </div>

    </div>

    <script type="module">
        
        // --- Global State Variables for Local Storage ---
        const DOCTOR_KEY = 'clinic_doctor_status';
        const PATIENTS_KEY = 'clinic_patients_cache';

        let doctorStatus = 'Departed'; // Default Doctor Status
        let patientsCache = [];         // Default Patient Cache

        const MAX_TOKENS = 50;
        const MOCK_NAMES = ["Alice Johnson", "Bob Smith", "Charlie Brown", "Diana Prince", "Ethan Hunt", "Fiona Glenanne", "George Costanza", "Hannah Baker", "Isaac Newton", "Julia Roberts"];
        const MOCK_PHONES = ["0987654321", "0912345678", "0955511223", "0998765432", "0944433221", "0977766554", "0922211009", "0966677889", "0933344556", "0900099887"];


        // --- Data Definitions ---
        const DOCTOR_STATUS = {
            ARRIVED: 'Arrived',
            DEPARTED: 'Departed'
        };

        const PATIENT_STATUS = {
            DEFAULT: 'Not Arrived',
            WAITING: 'Waiting',
            CONSULTING: 'Consulting',
            FINISHED: 'Finished',
            NOSHOW: 'No Show'
        };

        // Define the flow/next possible states for each status
        const STATUS_FLOW = {
            [PATIENT_STATUS.DEFAULT]: [PATIENT_STATUS.WAITING,PATIENT_STATUS.NOSHOW],
            [PATIENT_STATUS.WAITING]: [PATIENT_STATUS.CONSULTING, PATIENT_STATUS.NOSHOW],
            [PATIENT_STATUS.CONSULTING]: [PATIENT_STATUS.FINISHED],
            [PATIENT_STATUS.FINISHED]: [],
            [PATIENT_STATUS.NOSHOW]: []
        };

        // UI Elements
        const doctorToggleBtn = document.getElementById('doctor-toggle-btn');
        const doctorStatusDisplay = document.getElementById('doctor-status-display');
        const tokenBoard = document.getElementById('token-board');
        const modalContainer = document.getElementById('modal-container');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalTokenDisplay = document.getElementById('modal-token-display');
        const modalPatientName = document.getElementById('modal-patient-name');
        const modalPhoneNumberMasked = document.getElementById('modal-phone-number-masked'); 
        const modalCurrentStatus = document.getElementById('modal-current-status');
        const modalActions = document.getElementById('modal-actions');
        const loadingMessage = document.getElementById('loading-message');
        const modalFeedbackEl = document.getElementById('modal-feedback');
        
        // Search Elements
        const searchInput = document.getElementById('search-input');
        const clearSearchBtn = document.getElementById('clear-search-btn');

        // --- Utility Functions ---
        
        /**
         * Masks a 10-digit phone number to the format 09 *** XXXX.
         */
        function maskPhoneNumber(phone) {
            if (!phone || phone.length < 4) return phone;
            const lastFour = phone.slice(-4);
            return `09 *** ${lastFour}`;
        }

        function showFeedback(message, type = 'success') {
            modalFeedbackEl.textContent = message;
            modalFeedbackEl.className = `h-6 text-sm mb-4 font-medium ${type === 'success' ? 'text-emerald-600' : 'text-red-600'}`;
            // Clear feedback after 3 seconds
            setTimeout(() => { modalFeedbackEl.textContent = ''; }, 3000);
        }

        function getStatusColorClass(status) {
            switch (status) {
                case PATIENT_STATUS.WAITING: return 'status-card status-waiting';
                case PATIENT_STATUS.CONSULTING: return 'status-card status-consulting';
                case PATIENT_STATUS.FINISHED: return 'status-card status-finished';
                case PATIENT_STATUS.NOSHOW: return 'status-card status-noshow';
                default: return 'status-card status-default';
            }
        }

        function getNextStatusButtonColor(status) {
            switch (status) {
                case PATIENT_STATUS.WAITING: return 'bg-amber-500 text-white hover:bg-amber-600';
                case PATIENT_STATUS.CONSULTING: return 'bg-violet-500 text-white hover:bg-violet-600';
                case PATIENT_STATUS.FINISHED: return 'bg-emerald-500 text-white hover:bg-emerald-600';
                case PATIENT_STATUS.NOSHOW: return 'bg-red-500 text-white hover:bg-red-600';
                default: return 'bg-gray-500 text-white hover:bg-gray-600';
            }
        }

        function closeStatusModal() {
            modalContainer.classList.add('hidden');
            modalContainer.classList.remove('flex');
            modalActions.innerHTML = '';
            modalFeedbackEl.textContent = ''; // Clear feedback on close
        }

        // --- Local Storage Persistence ---

        function saveState() {
            try {
                localStorage.setItem(DOCTOR_KEY, doctorStatus);
                localStorage.setItem(PATIENTS_KEY, JSON.stringify(patientsCache));
            } catch (e) {
                console.error("Error saving state to localStorage:", e);
            }
        }
        
        // Fills the cache with default tokens if localStorage is empty
        function initializeMockData() {
            patientsCache = [];
            for (let i = 1; i <= MAX_TOKENS; i++) {
                const token = i;
                const mockIndex = token % MOCK_NAMES.length;
                const mockPhone = MOCK_PHONES[mockIndex];

                patientsCache.push({
                    token: token,
                    status: PATIENT_STATUS.DEFAULT,
                    name: MOCK_NAMES[mockIndex],
                    userPhone: mockPhone,
                    userPhoneMasked: maskPhoneNumber(mockPhone) 
                });
            }
            doctorStatus = DOCTOR_STATUS.DEPARTED;
            saveState();
        }

        function loadState() {
            const savedDoctorStatus = localStorage.getItem(DOCTOR_KEY);
            const savedPatients = localStorage.getItem(PATIENTS_KEY);

            if (savedDoctorStatus) {
                doctorStatus = savedDoctorStatus;
            }

            if (savedPatients) {
                try {
                    patientsCache = JSON.parse(savedPatients);
                } catch (e) {
                    console.error("Error parsing patients data from localStorage, resetting cache.", e);
                    initializeMockData();
                }
            } else {
                // Initialize for the first time
                initializeMockData();
            }
        }

        // --- Core Application Logic ---

        // 1. Doctor Status Management
        async function updateDoctorStatus(newStatus) {
            doctorStatus = newStatus;
            saveState();
            renderDoctorPanel(doctorStatus); // Immediate local update
        }

        function renderDoctorPanel(status) {
            const isArrived = status === DOCTOR_STATUS.ARRIVED;
            doctorStatusDisplay.textContent = status;
            doctorStatusDisplay.className = `font-bold ml-2 ${isArrived ? 'doctor-status-text-ARRIVED' : 'doctor-status-text-DEPARTED'}`;

            doctorToggleBtn.textContent = isArrived ? 'Set DEPARTED' : 'Set ARRIVED';
            doctorToggleBtn.style.backgroundColor = isArrived ? varToString('--color-danger') : varToString('--color-success');
            
            // Re-attach listener
            doctorToggleBtn.onclick = () => {
                const newStatus = isArrived ? DOCTOR_STATUS.DEPARTED : DOCTOR_STATUS.ARRIVED;
                updateDoctorStatus(newStatus);
            };

            // Helper to extract CSS variable value
            function varToString(variable) {
                return getComputedStyle(document.documentElement).getPropertyValue(variable).trim();
            }
        }

        // 2. Patient Status Management
        function updatePatientStatus(token, newStatus) {
            
            const patientIndex = patientsCache.findIndex(p => p.token === token);
            if (patientIndex === -1) {
                showFeedback("Error: Patient token not found in cache.", 'error');
                return;
            }

            const currentPatient = patientsCache[patientIndex];

            // Logic for setting name/phone when moving from DEFAULT to WAITING
            if (newStatus === PATIENT_STATUS.WAITING && currentPatient.status === PATIENT_STATUS.DEFAULT) {
                // Generate/Set mock details on first arrival
                const mockIndex = token % MOCK_NAMES.length;
                const mockPhone = MOCK_PHONES[mockIndex];

                currentPatient.name = MOCK_NAMES[mockIndex];
                currentPatient.userPhone = mockPhone;
                currentPatient.userPhoneMasked = maskPhoneNumber(mockPhone);
            }

            currentPatient.status = newStatus;

            // 1. Save state
            saveState();
            
            // 2. Render locally - Call filterTokens to maintain search state
            filterTokens(); 
            
            console.log(`Token ${token} status updated to: ${newStatus}`);
            showFeedback(`Status set to ${newStatus} for Token ${token}.`, 'success');
            
            // Close the modal slightly after the feedback shows
            setTimeout(closeStatusModal, 500); 
        }

        function openStatusModal(patient) {
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
            
            // Populate Modal Details
            modalTokenDisplay.textContent = `#${patient.token}`;
            modalPatientName.textContent = patient.name || 'N/A';
            modalPhoneNumberMasked.textContent = patient.userPhoneMasked || 'N/A'; 
            modalCurrentStatus.textContent = patient.status;
            
            modalActions.innerHTML = ''; // Clear previous buttons
            modalFeedbackEl.textContent = ''; // Clear previous feedback

            const nextStatuses = STATUS_FLOW[patient.status] || [];

            if (nextStatuses.length === 0 && patient.status !== PATIENT_STATUS.DEFAULT) {
                const p = document.createElement('p');
                p.className = 'text-center text-gray-500 p-2 border-t mt-2';
                p.textContent = `Token ${patient.token} is in a final status.`;
                modalActions.appendChild(p);
            } else {
                nextStatuses.forEach(status => {
                    const button = document.createElement('button');
                    
                    let buttonText = '';
                    // Customize button text for clarity
                    if (patient.status === PATIENT_STATUS.DEFAULT && status === PATIENT_STATUS.WAITING) {
                        buttonText = `Patient ARRIVED (Set to Waiting)`;
                    } else if (patient.status === PATIENT_STATUS.WAITING && status === PATIENT_STATUS.CONSULTING) {
                        buttonText = `Start CONSULTATION (Set to Consulting)`;
                    } else if (patient.status === PATIENT_STATUS.CONSULTING && status === PATIENT_STATUS.FINISHED) {
                        buttonText = `Consultation FINISHED`;
                    } else if (status === PATIENT_STATUS.NOSHOW) {
                        buttonText = `Patient is NO SHOW (Cancel Token)`;
                    } else {
                        buttonText = `Set to: ${status}`;
                    }

                    button.textContent = buttonText;
                    const buttonStyle = getNextStatusButtonColor(status);

                    button.className = `w-full py-3 font-semibold rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-[1.01] active:scale-95 text-lg ${buttonStyle}`;
                    button.onclick = () => updatePatientStatus(patient.token, status);
                    modalActions.appendChild(button);
                });
            }
        }

        // 3. Filtering Logic
        function filterTokens() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            
            if (!searchTerm) {
                // If the search term is empty, render all patients from cache
                renderTokenBoard(patientsCache);
                return;
            }

            const filteredPatients = patientsCache.filter(patient => {
                const tokenMatch = String(patient.token).includes(searchTerm);
                const nameMatch = patient.name.toLowerCase().includes(searchTerm);
                
                // --- MODIFIED: Search against the original (unmasked) phone number ---
                const phoneMatch = patient.userPhone.toLowerCase().includes(searchTerm); 
                // --------------------------------------------------------------------

                return tokenMatch || nameMatch || phoneMatch;
            });

            if (filteredPatients.length === 0) {
                 tokenBoard.innerHTML = '<p class="text-center col-span-full py-10 text-gray-500">No patients matched your search criteria.</p>';
                 loadingMessage.classList.add('hidden');
            } else {
                renderTokenBoard(filteredPatients);
            }
        }

        function clearSearch() {
            searchInput.value = '';
            filterTokens(); // Re-render all tokens
        }

        function renderTokenBoard(patientsData) {
            loadingMessage.classList.add('hidden');
            tokenBoard.innerHTML = '';
            
            patientsData.forEach(patient => {
                const card = document.createElement('div');
                card.className = `${getStatusColorClass(patient.status)} p-4 rounded-xl flex flex-col items-center justify-center text-center status-card token-clickable`;
                
                // Click handler uses the full patient object
                card.onclick = () => openStatusModal(patient);

                // Display the masked phone number on the card
                card.innerHTML = `
                    <p class="text-xs font-semibold uppercase opacity-90 mb-1">${patient.status}</p>
                    <h3 class="text-4xl font-extrabold leading-none">${patient.token}</h3>
                    <p class="text-xs mt-2 opacity-80">${patient.name.split(' ')[0]} @ ${patient.userPhoneMasked || 'N/A'}</p>
                `;
                tokenBoard.appendChild(card);
            });
        }

        // 4. Application Initialization
        function initializeData() {
            loadState();
            renderDoctorPanel(doctorStatus);
            // Initial render calls filterTokens, which renders all if search input is empty
            filterTokens(); 

            // --- Event Listeners ---
            modalCloseBtn.addEventListener('click', closeStatusModal);
            modalContainer.addEventListener('click', (e) => {
                if (e.target === modalContainer) {
                    closeStatusModal();
                }
            });
            
            // Search Listeners
            searchInput.addEventListener('input', filterTokens); // Filter as user types
            clearSearchBtn.addEventListener('click', clearSearch);
        }

        // Start the application initialization
        initializeData();

    </script>

</body>
</html>